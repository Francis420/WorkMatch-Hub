{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Job Details{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-8 mb-3">
            <div class="card shadow-sm p-4">
                <div class="card-body">
                    <h3 class="card-title">{{ job.title }}</h3>
                    <p class="text-muted">{{ job.get_job_type_display }} - {{ job.location }}</p>
                    <hr>
                    <h4>Job Description</h4>
                    <p>{{ job.description }}</p>
                    <h4>Requirements</h4>
                    <p>{{ job.requirements }}</p>
                    <h4>Job Details</h4>
                    <ul class="list-unstyled">
                        <li><strong>Salary:</strong> {{ job.salary }}</li>
                        <li><strong>Job Duration:</strong> {{ job.job_duration }}</li>
                        <li><strong>Total Slots:</strong> {{ job.total_slots }}</li>
                        <li><strong>Slots Remaining:</strong> {{ job.remaining_slots }}</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm p-4">
                <div class="card-body">
                    <h4>Employer Information</h4>
                    <p><strong>Name:</strong> {{ job.employer.profile.employer_name }}</p>
                    <p><strong>Email:</strong> <a href="mailto:{{ job.employer.email }}">{{ job.employer.email }}</a></p>
                    <p><strong>Contact:</strong> {{ job.employer.profile.contact_number }}</p>
                    <p><strong>Industry:</strong> {{ job.employer.profile.industry }}</p>
                    {% if job.employer.profile.website %}
                        <p><strong>Website:</strong> <a href="{{ job.employer.profile.website }}" target="_blank">{{ job.employer.profile.website }}</a></p>
                    {% endif %}
                    {% if job.employer.profile.company_logo %}
                        <img src="{{ job.employer.profile.company_logo.url }}" alt="Company Logo" class="img-fluid mt-3">
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if hired %}
        <div class="alert alert-success text-center py-4">
            <h5 class="fw-bold text-white">ðŸŽ‰ Congratulations! ðŸŽ‰</h5>
            <p class="text-light">You were hired for this job on <strong>{{ hired_date|date:"F j, Y, g:i A" }}</strong>.</p>
        </div>
        <button class="btn btn-success w-100" disabled>ðŸŽ‰ Hired - Congratulations!</button>

    {% elif rejected and reapply_time %}
        <div class="alert alert-danger text-center py-4">
            <h5 class="fw-bold text-white">You were rejected.</h5>
            <p class="text-light">You can reapply after:</p>
            <p class="fw-bold text-light" id="countdown-timer"></p> <!-- Countdown Timer -->
            <div class="progress mt-2">
                <div id="countdown-progress" class="progress-bar bg-light" role="progressbar" style="width: 0%;"></div>
            </div>
        </div>
        <button class="btn btn-secondary w-100" disabled>Apply (Cooldown Active)</button>

    {% elif pending %}
        <div class="alert alert-warning text-center py-4">
            <h5 class="fw-bold text-dark">Application Received!</h5>
            <p class="text-dark">Your application was submitted on <strong>{{ pending_since|date:"F j, Y, g:i A" }}</strong>.</p>
            <p class="text-dark">Please wait for the employer to process your application.</p>
        </div>
        <button class="btn btn-warning w-100" disabled>Application Pending...</button>

    {% else %}
        <a href="{% url 'jobs:apply_for_job' job.id %}" class="btn btn-primary w-100">Apply for this job</a>
    {% endif %}

    {% if job.employer == user %}
        <a href="{% url 'jobs:update_job' job.id %}" class="btn btn-warning w-100 mt-2">Update Job</a>
        <a href="{% url 'jobs:delete_job' job.id %}" class="btn btn-danger w-100 mt-2">Delete Job</a>
    {% endif %}

    <div class="mt-3 text-center">
        <a href="javascript:history.back()" class="btn btn-outline-secondary">Go Back</a>
    </div>

    {% if rejected and reapply_time %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const countdownElement = document.getElementById('countdown-timer');
        const progressBar = document.getElementById('countdown-progress');
        const endTime = new Date("{{ reapply_time|date:'Y-m-d H:i:s' }}").getTime();
        const startTime = new Date().getTime();

        function updateCountdown() {
            const now = new Date().getTime();
            const distance = endTime - now;

            if (distance <= 0) {
                countdownElement.innerHTML = "<span class='text-success fw-bold'>You can now reapply!</span>";
                progressBar.style.width = "100%";
                progressBar.classList.replace("bg-light", "bg-success");
                progressBar.textContent = "Ready!";
                clearInterval(interval);
                return;
            }

            const months = Math.floor(distance / (1000 * 60 * 60 * 24 * 30));
            const days = Math.floor((distance % (1000 * 60 * 60 * 24 * 30)) / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            countdownElement.innerHTML = `
                <span class="fw-bold fs-4">${months} months ${days} days ${hours} hours ${minutes} minutes ${seconds} seconds</span>
            `;

            const totalDuration = endTime - startTime;
            const progress = ((totalDuration - distance) / totalDuration) * 100;
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${Math.round(progress)}%`;
        }

        updateCountdown();
        const interval = setInterval(updateCountdown, 1000);
    });
    </script>
    {% endif %}
</div>
{% endblock %}
