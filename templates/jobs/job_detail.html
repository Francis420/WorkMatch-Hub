{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Job Details{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-8 mb-3">
            <div class="card shadow-sm p-4">
                <div class="card-body">
                    <h3 class="card-title">{{ job.title }}</h3>
                    <p class="text-muted">{{ job.get_job_type_display }} - {{ job.location }}</p>
                    <hr>
                    <h4>Job Description</h4>
                    <p>{{ job.description }}</p>
                    <h4>Requirements</h4>
                    <p>{{ job.requirements }}</p>
                    <h4>Job Details</h4>
                    <ul class="list-unstyled">
                        <li><strong>Salary:</strong> {{ job.salary }}</li>
                        <li><strong>Job Duration:</strong> {{ job.job_duration }}</li>
                        <li><strong>Total Slots:</strong> {{ job.total_slots }}</li>
                        <li><strong>Slots Remaining:</strong> {{ job.remaining_slots }}</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm p-4">
                <div class="card-body">
                    <h4>Employer Information</h4>
                    <p><strong>Name:</strong> {{ job.employer.profile.employer_name }}</p>
                    <p><strong>Email:</strong> <a href="mailto:{{ job.employer.email }}">{{ job.employer.email }}</a></p>
                    <p><strong>Contact:</strong> {{ job.employer.profile.contact_number }}</p>
                    <p><strong>Industry:</strong> {{ job.employer.profile.industry }}</p>
                    {% if job.employer.profile.website %}
                        <p><strong>Website:</strong> <a href="{{ job.employer.profile.website }}" target="_blank">{{ job.employer.profile.website }}</a></p>
                    {% endif %}
                    {% if job.employer.profile.company_logo %}
                        <img src="{{ job.employer.profile.company_logo.url }}" alt="Company Logo" class="img-fluid mt-3">
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-3">
        <a href="javascript:history.back()" class="btn btn-secondary">Back</a>
    </div>
    
    {% if user.is_authenticated and user.is_job_seeker %}
    <div class="mt-3">
        {% if can_apply %}
        <form id="application-form" action="{% url 'jobs:apply_for_job' job.id %}" method="post">
            {% csrf_token %}
            <button type="button" id="apply-button" class="btn btn-primary" onclick="handleApplication()">
                {% if user_has_applied and not rejected %}
                    Cancel Application
                {% else %}
                    Apply for this job
                {% endif %}
            </button>
        </form>
        {% elif rejected %}
            <p class="text-warning">You previously applied and were rejected. Consider improving your resume for better chances.</p>
            <button class="btn btn-primary">Apply Again</button>
        {% else %}
        <p id="countdown-timer" class="text-danger"></p>
        <button class="btn btn-secondary" disabled>Apply (Cooldown Active)</button>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
function handleApplication() {
    const applyButton = document.getElementById('apply-button');
    const form = document.getElementById('application-form');
    const isApplied = applyButton.textContent.trim() === 'Cancel Application';
    
    if (isApplied) {
        if (confirm('Are you sure you want to cancel your application?')) {
            form.action = "{% url 'jobs:cancel_application' job.id %}";
            form.submit();
        }
    } else {
        if (confirm('Are you sure you want to apply for this job?')) {
            form.submit();
        }
    }
}

{% if not can_apply %}
document.addEventListener('DOMContentLoaded', function() {
    const countdownElement = document.getElementById('countdown-timer');
    const endTime = new Date("{{ reapply_time|date:'Y-m-d H:i:s' }}").getTime();
    const interval = setInterval(function() {
        const now = new Date().getTime();
        const distance = endTime - now;
        
        if (distance < 0) {
            clearInterval(interval);
            countdownElement.textContent = "You can now reapply for this job.";
            location.reload();
        } else {
            const months = Math.floor(distance / (1000 * 60 * 60 * 24 * 30));
            const days = Math.floor((distance % (1000 * 60 * 60 * 24 * 30)) / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            countdownElement.textContent = `You can reapply in ${months}m ${days}d ${hours}h ${minutes}m ${seconds}s`;
        }
    }, 1000);
});
{% endif %}
</script>
{% endblock %}